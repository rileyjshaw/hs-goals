var terra=terra||{};!function(e){function t(e){return Math.floor(Math.random()*e)}function r(e){var r=e.length;if(!r)throw new Error("The array is empty.");return e[t(r)]}function n(e,t){return function(){e[t].apply(e,arguments)}}function o(e,t){for(var r=0,n=e.length;n>r;r++)t(e[r])}function i(e,t){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t(r,e[r])}function c(e){this.values=e||{}}function a(e,t){this.x=e,this.y=t}function s(e,t){this.width=e,this.height=t,this.cells=new Array(t);for(var r=t-1;r>=0;r--)this.cells[r]=new Array(e)}function u(e,t){for(var r=document.querySelector(t),n=e[0].length,o=e.length,i=new s(n,o),c=0;o>c;c++)for(var u=e[c],h=0;n>h;h++){{new a(h,c)}i.cells[c][h]=p(u[h])}this.grid=i;for(var l=document.createDocumentFragment(),y=n*o;y>=0;y--){var f=document.createElement("span");y%n===0&&(f.style.clear="left"),l.appendChild(f)}r.innerHTML="",r.appendChild(l),this.spans=r.childNodes}function p(e){if(" "===e)return void 0;if(f.contains(e))return new(f.lookup(e));throw new Error("Unknown character: ")+e}function h(e){return void 0===e?" ":e.character}function l(e,t){var r=[];return y.each(function(n){e[n].character==t&&r.push(n)}),r}c.prototype.store=function(e,t){this.values[e]=t},c.prototype.lookup=function(e){return this.values[e]},c.prototype.contains=function(e){return Object.prototype.propertyIsEnumerable.call(this.values,e)},c.prototype.each=function(e){i(this.values,e)},c.prototype.names=function(){var e=[];return this.each(function(t){e.push(t)}),e};var y=new c({n:new a(0,-1),ne:new a(1,-1),e:new a(1,0),se:new a(1,1),s:new a(0,1),sw:new a(-1,1),w:new a(-1,0),nw:new a(-1,-1)}),f=new c;f.register=function(e,t){e.prototype.character=t,f.store(t,e)},a.prototype.add=function(e){return new a(this.x+e.x,this.y+e.y)},s.prototype.isInside=function(e){return e.x>=0&&e.y>=0&&e.x<this.width&&e.y<this.height},s.prototype.moveValue=function(e,t){this.cells[t.y][t.x]=this.cells[e.y][e.x],this.cells[e.y][e.x]=void 0},s.prototype.each=function(e){for(var t=0;t<this.height;t++)for(var r=0;r<this.width;r++){var n=new a(r,t);e(n,this.cells[t][r])}},u.prototype.toString=function(){var e=[],t=this.grid.width-1;return this.grid.each(function(r,n){e.push(h(n)),r.x===t&&e.push("\n")}),e.join("")},u.prototype.toDom=function(){var e=this;this.grid.each(function(t,r){var n=e.spans[t.y*e.grid.width+t.x];r?(n.style.color="rgb("+r.currentColor+")",n.textContent=h(r)):n.textContent=" "})},u.prototype.listActingCreatures=function(){var e=[];return this.grid.each(function(t,r){void 0!==r&&r.act&&e.push({object:r,point:t})}),e},u.prototype.listSurroundings=function(e){var t={},r=this.grid;return y.each(function(n,o){var i=e.add(o);t[n]=r.isInside(i)?{character:h(r.cells[i.y][i.x]),object:r.cells[i.y][i.x]}:{character:"#",object:null}}),t},u.prototype.step=function(){o(this.listActingCreatures(),n(this,"processCreature"))},u.prototype.processCreature=function(e){function t(){if(!y.contains(i.direction))return null;var t=e.point.add(y.lookup(i.direction));return u.grid.isInside(t)?t:null}var r,n,o,i,c=e.object.energy,a=e.object.maxEnergy,s=e.object.color,u=this;for(r=2;r>=0;r--)o=s[r],e.object.currentColor[r]=Math.floor(o+(255-o)*(1-c/a));switch(i=e.object.act(this.listSurroundings(e.point)),i.type){case"move":n=this.creatureMove(e.object,e.point,t());break;case"eat":n=this.creatureEat(e.object,t());break;case"photosynthesize":n=2*(e.object.efficiency||1);break;case"reproduce":n=this.creatureReproduce(e.object,t());break;case"wait":n=.4*(e.object.moveCost||-1);break;case"skip":break;default:throw new Error("Unsupported action: "+i.type)}"skip"!==i.type&&(e.object.energy+=n)<=0?this.grid.cells[e.point.y][e.point.x]=void 0:e.object.energy>e.object.maxEnergy&&(e.object.energy=e.object.maxEnergy)},u.prototype.creatureMove=function(e,t,r){return null!==r&&void 0===this.grid.cells[r.y][r.x]&&(this.grid.moveValue(t,r),t.x=r.x,t.y=r.y),e.moveCost||-1},u.prototype.creatureEat=function(e,t){var r=e.moveCost||-1;if(null!==t){var n=this.grid.cells[t.y][t.x];void 0!==n&&(r=n.energy,this.grid.cells[t.y][t.x]=void 0)}return r*(e.efficiency||1)},u.prototype.creatureReproduce=function(e,t){var r=1;if(null!==t&&void 0===this.grid.cells[t.y][t.x]){var n=h(e),o=p(n);r=2*o.energy,e.energy>=r&&(this.grid.cells[t.y][t.x]=o)}return-r*(e.efficiency||1)},e.randomElement=r,e.Terrarium=u,e.registerCreatureType=f.register,e.findDirections=l,e.directions=y,e.forEach=o}(terra.util=terra.util||{}),terra.create=function(e,t){if(Terrarium=terra.util.Terrarium,"string"!=typeof e)throw new Error('You need to pass an element selector (string) as the first argument of terra.create (received "'+e+'")');t=t||terra.maps.mSmall(["*","C"," ","#"]);var r=function(e){var t=function(){e(),requestAnimationFrame(t)};requestAnimationFrame(t)},n=new Terrarium(t,e);r(function(){n.step(),n.toDom()})},function(){function e(){this.currentColor=[]}function t(){this.energy=5,this.currentColor=[]}function r(){this.energy=8,this.direction="ne",this.currentColor=[]}function n(){this.energy=10,this.currentColor=[]}function o(){this.energy=1,this.currentColor=[]}randomElement=terra.util.randomElement,registerCreatureType=terra.util.registerCreatureType,findDirections=terra.util.findDirections,directions=terra.util.directions,forEach=terra.util.forEach,e.prototype.color=[0,0,0],registerCreatureType(e,"#"),t.prototype.color=[0,255,0],t.prototype.maxEnergy=20,t.prototype.efficiency=.5,t.prototype.act=function(e){var t=findDirections(e," ");return this.energy>=13&&t.length>0?{type:"reproduce",direction:randomElement(t)}:{type:"photosynthesize"}},registerCreatureType(t,"*"),r.prototype.color=[0,0,255],r.prototype.maxEnergy=50,r.prototype.moveCost=-2,r.prototype.act=function(e){var t=findDirections(e," "),r=findDirections(e,"*");return this.energy>=30&&t.length>0?{type:"reproduce",direction:randomElement(t)}:r.length>1?{type:"eat",direction:randomElement(r)}:t.length>1?{type:"move",direction:this.direction}:{type:"wait"}},registerCreatureType(r,"/"),n.prototype.color=[255,0,0],n.prototype.maxEnergy=50,n.prototype.act=function(e){var t=findDirections(e," "),r=findDirections(e,"*");return this.energy>=30&&t.length>0?{type:"reproduce",direction:randomElement(t)}:r.length>1?{type:"eat",direction:randomElement(r)}:t.length>0?{type:"move",direction:randomElement(directions.names())}:{type:"wait"}},registerCreatureType(n,"C"),o.prototype.color=[0,0,0],o.prototype.maxEnergy=1,o.prototype.act=function(e){var t=0;return directions.each(function(r){e[r].character===this.character&&1===e[r].object.energy&&t++}),this.energy?2!==t&&3!==t&&(this.energy=0):3===t&&(this.energy=1),{type:"skip"}},registerCreatureType(o,"L")}(terra.creatures=terra.creatures||{}),function(e){randomElement=terra.util.randomElement;var t=["############################","#       L                  #","#       L                  #","#       L                  #","#                          #","#         L                #","#          L               #","#        LLL               #","#                    L     #","#                   L      #","#                          #","############################"],r=function(e,t,r){for(var n=new Array(""),o=e-1;o>=0;o--)for(var i=t-1;i>=0;i--)i==t-1?(character="",n[o]="#"):character=o&&i&&o!=e-1?randomElement(r):"#",n[o]+=character;return n};e.mGameOfLife=t,e.mSmall=function(e){return r(24,48,e)},e.mMedium=function(e){return r(48,96,e)},e.mBig=function(e){return r(56,144,e)},e.mapGen=r}(terra.maps=terra.maps||{});